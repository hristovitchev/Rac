<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jensen's Bull Run: 2D Classic</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #111;
            font-family: 'Courier New', Courier, monospace;
            touch-action: none;
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 95%;
            pointer-events: none;
            z-index: 5;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .stat-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .stat-text {
            color: #76b900;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 2px 2px 0px #000;
            min-width: 140px;
        }
        
        #hype-container {
            width: 150px;
            height: 18px;
            border: 2px solid #fff;
            background: #222;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        #hype-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #55aaff, #ffffff);
            transition: width 0.1s linear;
        }
        #hype-label {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #fff; 
            font-weight: bold;
            text-shadow: 1px 1px 2px #000, -1px -1px 2px #000; 
        }

        #notification-area {
            position: absolute;
            top: 25%;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 20;
        }
        .float-text {
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 10px #000;
            animation: floatUp 1.5s ease-out forwards;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        @keyframes floatUp {
            0% { opacity: 1; margin-top: 0; transform: translateX(-50%) scale(1); }
            20% { transform: translateX(-50%) scale(1.2); }
            100% { opacity: 0; margin-top: -80px; transform: translateX(-50%) scale(1); }
        }

        #start-screen, #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #0a0a0a;
            background-image: linear-gradient(rgba(0, 20, 0, 0.9), rgba(0, 0, 0, 0.95));
            color: #fff;
            z-index: 100;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .icon-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
        }
        .start-svg {
            width: 100px;
            height: 100px;
            filter: drop-shadow(0 0 15px rgba(118, 185, 0, 0.4));
        }

        h1 {
            color: #76b900;
            font-size: 32px;
            margin-bottom: 10px;
            text-align: center;
            text-transform: uppercase;
            text-shadow: 0 0 10px #76b900;
            line-height: 1.1;
        }
        p {
            font-size: 16px;
            color: #ddd;
            text-align: center;
            max-width: 90%;
            line-height: 1.4;
            margin: 5px 0;
        }
        button {
            margin-top: 25px;
            padding: 15px 40px;
            font-size: 20px;
            background: #76b900;
            border: none;
            color: black;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0 0 15px #76b900;
            transition: transform 0.1s;
        }
        button:active {
            transform: scale(0.95);
        }
        .controls-hint {
            margin-top: 20px;
            font-size: 12px;
            color: #aaa;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="stat-row">
        <div class="stat-text">STOCK: $<span id="score">0.00</span></div>
    </div>
    <div class="stat-row">
        <div class="stat-text">M.CAP: <span id="market-cap">0.00</span> T</div>
    </div>
    <div class="stat-row">
        <div class="stat-text" style="min-width: 80px; font-size: 14px;">CONTRACTS:</div>
        <div id="hype-container">
            <div id="hype-fill"></div>
            <div id="hype-label">0/15</div>
        </div>
    </div>
</div>

<div id="notification-area"></div>

<div id="start-screen">
    <div class="icon-container">
        <!-- Smiling Jensen Icon -->
        <svg class="start-svg" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="35" fill="#f5d0b0" />
            <path d="M15 50 C 15 20, 20 5, 50 5 C 80 5, 85 20, 85 50 L 80 60 C 80 30, 20 30, 20 60 Z" fill="#e0e0e0" />
            <path d="M30 15 Q 50 5, 70 15" stroke="#bbb" stroke-width="2" fill="none" />
            <rect x="25" y="45" width="20" height="12" rx="3" fill="rgba(200,220,255,0.5)" stroke="black" stroke-width="3"/>
            <rect x="55" y="45" width="20" height="12" rx="3" fill="rgba(200,220,255,0.5)" stroke="black" stroke-width="3"/>
            <line x1="45" y1="51" x2="55" y2="51" stroke="black" stroke-width="3"/>
            <line x1="15" y1="48" x2="25" y2="48" stroke="black" stroke-width="3"/>
            <line x1="75" y1="48" x2="85" y2="48" stroke="black" stroke-width="3"/>
            <circle cx="35" cy="51" r="3" fill="black" />
            <circle cx="65" cy="51" r="3" fill="black" />
            <path d="M35 70 Q 50 80, 65 70" stroke="#c98c61" stroke-width="3" fill="none" />
        </svg>

        <!-- Sad Bear Icon -->
        <svg class="start-svg" viewBox="0 0 100 100">
            <circle cx="50" cy="55" r="35" fill="#654321" />
            <circle cx="20" cy="30" r="12" fill="#3d2611" />
            <circle cx="80" cy="30" r="12" fill="#3d2611" />
            <ellipse cx="50" cy="65" rx="15" ry="12" fill="#8a6242" />
            <circle cx="50" cy="60" r="5" fill="black" />
            <path d="M30 45 Q 35 40, 40 45" stroke="white" stroke-width="3" fill="none" />
            <path d="M60 45 Q 65 40, 70 45" stroke="white" stroke-width="3" fill="none" />
            <path d="M40 80 Q 50 70, 60 80" stroke="black" stroke-width="2" fill="none" />
            <path d="M65 50 Q 70 60, 65 65 Q 60 60, 65 50" fill="#55aaff" />
        </svg>
    </div>

    <h1>Jensen's Bull Run</h1>
    <p>Collect <strong>15 Contracts</strong> to go PARABOLIC.</p>
    <p>Grab <strong>GB300 Chips</strong> for Shield & Jump.</p>
    <button id="start-btn">INITIALIZE RALLY</button>
    <div class="controls-hint">
        Tap LEFT to Jump â¢ Tap RIGHT to Shoot
    </div>
</div>

<div id="game-over-screen" style="display: none;">
    <h1 style="color: #ff3333">MARKET CRASH</h1>
    <p>The bears overwhelmed the market.</p>
    <p>Final Stock Price: $<span id="final-score">0</span></p>
    <p>Final Market Cap: <span id="final-market-cap">0</span> T</p>
    <button id="restart-btn">BUY THE DIP (RESTART)</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    // --- Audio System ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
    }

    function playSound(type) {
        if (!audioCtx || audioCtx.state === 'suspended') return;
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        const now = audioCtx.currentTime;
        if (type === 'jump') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if (type === 'shoot') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.15);
            gainNode.gain.setValueAtTime(0.05, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
            osc.start(); osc.stop(now + 0.15);
        } else if (type === 'hit') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(100, now);
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if (type === 'contract') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(1200, now);
            osc.frequency.exponentialRampToValueAtTime(1800, now + 0.1);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            osc.start(); osc.stop(now + 0.2);
        } else if (type === 'parabolic') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.linearRampToValueAtTime(800, now + 1.0);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 1.0);
            osc.start(); osc.stop(now + 1.0);
        } else if (type === 'powerup') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.linearRampToValueAtTime(1200, now + 0.2);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start(); osc.stop(now + 0.3);
        } else if (type === 'shield_break') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.2);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(); osc.stop(now + 0.2);
        }
    }

    // --- UI Helpers ---
    function showNotification(text, color) {
        const el = document.createElement('div');
        el.innerText = text;
        el.style.color = color;
        el.className = 'float-text';
        document.getElementById('notification-area').appendChild(el);
        setTimeout(() => el.remove(), 1500);
    }

    function updateContractUI(count) {
        const max = 15;
        const pct = Math.min(100, (count / max) * 100);
        document.getElementById('hype-fill').style.width = pct + '%';
        document.getElementById('hype-label').innerText = count + '/' + max;
        if (pct >= 100) {
            document.getElementById('hype-fill').style.background = '#ffd700'; 
        } else {
            document.getElementById('hype-fill').style.background = 'linear-gradient(90deg, #55aaff, #ffffff)';
        }
    }

    // --- Game Setup ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let width, height;
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    let gameRunning = false;
    let score = 0;
    let marketCap = 0;
    let frames = 0;
    let gameSpeed = 5;
    let contractsCollected = 0;
    let isParabolic = false;
    let parabolicTimer = 0;
    
    let player;
    let terrain = [];
    let bullets = [];
    let bears = [];
    let powerups = [];
    let contracts = [];
    let particles = [];

    // --- Terrain ---
    const segmentWidth = 50;
    function initTerrain() {
        terrain = [];
        let y = height * 0.6;
        for (let x = 0; x <= width + segmentWidth; x += segmentWidth) {
            terrain.push({ x: x, y: y });
        }
    }

    function updateTerrain() {
        for (let t of terrain) t.x -= gameSpeed;
        if (terrain[0].x < -segmentWidth) terrain.shift();
        
        let lastPoint = terrain[terrain.length - 1];
        if (lastPoint.x < width + segmentWidth) {
            let change;
            if (isParabolic) {
                change = -15 - Math.random() * 20; 
            } else {
                change = (Math.random() - 0.45) * 60; 
            }
            let newY = lastPoint.y + change;
            let minY = height * 0.2;
            let maxY = height * 0.9;
            newY = Math.max(minY, Math.min(maxY, newY));
            terrain.push({ x: lastPoint.x + segmentWidth, y: newY });
        }
    }

    function drawTerrain() {
        for (let i = 0; i < terrain.length - 1; i++) {
            let p1 = terrain[i];
            let p2 = terrain[i+1];
            let isDip = p2.y > p1.y;
            
            let color, fillColor;

            if (isParabolic) {
                color = '#ffd700'; 
                fillColor = 'rgba(255, 215, 0, 0.4)';
            } else {
                color = isDip ? '#ff3333' : '#76b900';
                fillColor = isDip ? 'rgba(255, 51, 51, 0.4)' : 'rgba(118, 185, 0, 0.4)';
            }

            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.lineTo(p2.x, height);
            ctx.lineTo(p1.x, height);
            ctx.closePath();
            ctx.fillStyle = fillColor;
            ctx.fill();

            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.stroke();
        }
    }

    function getGroundY(x) {
        for (let i = 0; i < terrain.length - 1; i++) {
            if (x >= terrain[i].x && x <= terrain[i+1].x) {
                let t = (x - terrain[i].x) / (terrain[i+1].x - terrain[i].x);
                return terrain[i].y + t * (terrain[i+1].y - terrain[i].y);
            }
        }
        return height; 
    }

    // --- Logic Helpers ---
    function collectContract() {
        if (isParabolic) return; 
        contractsCollected++;
        updateContractUI(contractsCollected);
        
        playSound('contract'); 
        showNotification("CONTRACT SIGNED! +$50", "#55aaff"); 
        
        if (contractsCollected >= 15) {
            startParabolicMode();
        }
    }

    function startParabolicMode() {
        isParabolic = true;
        contractsCollected = 0;
        updateContractUI(15); 
        parabolicTimer = 600; 
        showNotification("PARABOLIC MODE ACTIVATED!", "#ffd700");
        playSound('parabolic');
    }

    function endParabolicMode() {
        isParabolic = false;
        contractsCollected = 0;
        updateContractUI(0);
    }

    // --- Global Classes ---

    class Bullet { 
        constructor(x, y) { this.x = x; this.y = y; this.width = 15; this.height = 5; this.speed = 15; this.active = true; } 
        update() { this.x += this.speed; if(this.x>width) this.active=false; } 
        draw() { 
            ctx.fillStyle='#76b900'; 
            ctx.fillRect(this.x,this.y,this.width,this.height); 
            ctx.shadowColor='#76b900'; ctx.shadowBlur=10; 
            ctx.fillRect(this.x,this.y,this.width,this.height); ctx.shadowBlur=0; 
        } 
    }

    class Bear { 
        constructor() { this.width=70; this.height=50; this.x=width+this.width; this.y=0; this.speed=gameSpeed+Math.random()*2; this.active=true; this.frameOffset=Math.random()*10; } 
        update() { this.x-=this.speed; let gY=getGroundY(this.x+this.width/2); this.y=gY-this.height+5; if(this.x+this.width<0) this.active=false; } 
        draw() { 
            ctx.save(); ctx.translate(this.x,this.y); let bob=Math.sin(frames*0.2+this.frameOffset)*4; ctx.translate(0,bob); 
            let fg=ctx.createRadialGradient(35,25,10,35,25,50); fg.addColorStop(0,'#654321'); fg.addColorStop(1,'#3d2611'); 
            ctx.fillStyle=fg; ctx.beginPath(); ctx.ellipse(45,28,22,18,0,0,Math.PI*2); ctx.fill(); 
            ctx.beginPath(); ctx.ellipse(25,25,20,22,-0.1,0,Math.PI*2); ctx.fill(); 
            ctx.save(); ctx.translate(5,15); ctx.fillStyle='#3d2611'; ctx.beginPath(); ctx.arc(12,-5,6,0,Math.PI*2); ctx.fill(); 
            ctx.beginPath(); ctx.arc(4,-2,6,0,Math.PI*2); ctx.fill(); 
            ctx.fillStyle=fg; ctx.beginPath(); ctx.arc(10,10,14,0,Math.PI*2); ctx.fill(); 
            ctx.fillStyle='#8a6242'; ctx.beginPath(); ctx.ellipse(0,14,10,8,0.2,0,Math.PI*2); ctx.fill(); 
            ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(-6,14,3,0,Math.PI*2); ctx.fill(); 
            ctx.fillStyle='#f00'; ctx.beginPath(); ctx.arc(5,8,2.5,0,Math.PI*2); ctx.fill(); ctx.restore(); 
            ctx.fillStyle='#3d2611'; ctx.save(); ctx.translate(55,35); ctx.rotate(Math.sin(frames*0.4)*0.5); ctx.fillRect(-6,0,12,18); ctx.restore(); 
            ctx.save(); ctx.translate(20,35); ctx.rotate(-Math.sin(frames*0.4)*0.5); ctx.fillRect(-6,0,12,18); ctx.restore(); ctx.restore(); 
        } 
    }

    class Particle { 
        constructor(x,y,c='#00ff00'){this.x=x;this.y=y;this.vx=(Math.random()-0.5)*8;this.vy=(Math.random()-0.5)*8;this.life=1.0;this.color=c;} 
        update(){this.x+=this.vx;this.y+=this.vy;this.life-=0.05;} 
        draw(){ctx.save();ctx.globalAlpha=this.life;ctx.fillStyle=this.color;ctx.fillRect(this.x,this.y,4,4);ctx.restore();} 
    }

    class PowerUp { 
        constructor() { this.width = 30; this.height = 30; this.x = width + 50; this.y = 0; this.active = true; this.floatOffset = Math.random() * Math.PI * 2; }
        update() { this.x -= gameSpeed; let groundY = getGroundY(this.x + this.width/2); let hover = Math.sin(frames * 0.1 + this.floatOffset) * 10; this.y = groundY - 80 + hover; if (this.x < -50) this.active = false; }
        draw() { ctx.save(); ctx.translate(this.x, this.y); ctx.fillStyle = '#111'; ctx.strokeStyle = '#444'; ctx.lineWidth = 2; ctx.beginPath(); ctx.roundRect(0, 0, this.width, this.height, 4); ctx.fill(); ctx.stroke(); ctx.fillStyle = '#00ff00'; ctx.font = 'bold 8px Arial'; ctx.textAlign = 'center'; ctx.fillText("GB300", this.width/2, this.height/2 + 3); ctx.shadowColor = '#00ff00'; ctx.shadowBlur = 10; ctx.strokeStyle = '#00ff00'; ctx.strokeRect(0,0,this.width, this.height); ctx.shadowBlur = 0; ctx.restore(); }
    }

    class Contract { 
        constructor() { this.width = 25; this.height = 32; this.x = width + 50; this.y = 0; this.active = true; this.floatOffset = Math.random() * Math.PI * 2; this.color = '#55aaff'; }
        update() { this.x -= gameSpeed; let groundY = getGroundY(this.x + this.width/2); let baseHeight = (frames % 200 > 100) ? 120 : 60; let hover = Math.sin(frames * 0.08 + this.floatOffset) * 10; this.y = groundY - baseHeight + hover; if (this.x < -50) this.active = false; }
        draw() { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(Math.sin(frames * 0.05 + this.floatOffset) * 0.1); ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.roundRect(0, 0, this.width, this.height, 2); ctx.fill(); ctx.fillStyle = this.color; ctx.fillRect(2, 2, this.width - 4, 8); ctx.fillStyle = '#ccc'; ctx.fillRect(4, 14, this.width - 8, 2); ctx.fillRect(4, 18, this.width - 8, 2); ctx.fillStyle = '#000'; ctx.font = '8px cursive'; ctx.fillText("x______", 4, 30); if (frames % 20 < 10) { ctx.fillStyle = '#fff'; ctx.fillRect(-2, -2, 2, 2); } ctx.restore(); }
    }

    class Player {
        constructor() { this.x = width * 0.2; this.y = 0; this.width = 45; this.height = 75; this.vy = 0; this.baseJumpForce = -13; this.gravity = 0.6; this.grounded = false; this.shootTimer = 0; this.runCycle = 0; this.isOverclocked = false; }
        update() { 
            let currentGravity = (this.isOverclocked || isParabolic) ? 0.45 : 0.6; 
            if (isParabolic && this.grounded) { this.vy = -15; this.grounded = false; }
            this.vy += currentGravity; this.y += this.vy;
            let groundY = getGroundY(this.x);
            if (this.y >= groundY - this.height) { this.y = groundY - this.height; this.vy = 0; this.grounded = true; } else { this.grounded = false; }
            if (this.shootTimer > 0) this.shootTimer--;
            if (isParabolic && this.y > height) { this.y = height - 100; this.vy = -20; } else if (this.y > height + 100) { gameOver(); }
            this.runCycle += isParabolic ? 0.5 : 0.25; 
        }
        jump() { if (this.grounded) { this.vy = (this.isOverclocked || isParabolic) ? -20 : -13; this.grounded = false; playSound('jump'); if (this.isOverclocked) { for(let i=0; i<8; i++) particles.push(new Particle(this.x + 20, this.y + 70)); } } }
        activatePowerUp() { this.isOverclocked = true; showNotification("GB300 SHIELD!", "#00ff00"); }
        losePowerUp() { this.isOverclocked = false; playSound('shield_break'); showNotification("SHIELD BROKEN", "#ff3333"); }
        shoot() { if (this.shootTimer === 0) { let bY = this.y + this.height * 0.6; bullets.push(new Bullet(this.x + this.width, bY)); if (isParabolic) { bullets.push(new Bullet(this.x + this.width, bY - 20)); bullets.push(new Bullet(this.x + this.width, bY + 20)); } this.shootTimer = isParabolic ? 5 : 20; playSound('shoot'); } }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            if (isParabolic) { ctx.save(); ctx.globalAlpha = 0.5 + Math.sin(frames * 0.5) * 0.2; ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.ellipse(22, 35, 50, 60, 0, 0, Math.PI*2); ctx.fill(); ctx.restore(); } 
            else if (this.isOverclocked) { ctx.save(); ctx.globalAlpha = 0.3 + Math.sin(frames * 0.2) * 0.1; ctx.fillStyle = '#00ff00'; ctx.beginPath(); ctx.ellipse(22, 35, 40, 50, 0, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2; ctx.beginPath(); ctx.ellipse(22, 35, 30, 40, frames * 0.05, 0, Math.PI); ctx.stroke(); ctx.restore(); }
            let cycle = this.runCycle; let lThighAngle = this.grounded ? Math.sin(cycle) * 0.5 : 0.5; let rThighAngle = this.grounded ? Math.sin(cycle + Math.PI) * 0.5 : -0.5; let lCalfAngle = this.grounded ? Math.max(0, Math.sin(cycle - 0.5)) * 1.2 : 0.2; let rCalfAngle = this.grounded ? Math.max(0, Math.sin(cycle + Math.PI - 0.5)) * 1.2 : 0.2; let bounce = this.grounded ? Math.abs(Math.sin(cycle*2)) * 3 : 0; let tilt = this.grounded ? 0.1 : -0.1; 
            ctx.translate(0, -bounce); ctx.rotate(tilt);
            ctx.fillStyle = '#2a2a2a'; ctx.save(); ctx.translate(28, 55); ctx.rotate(rThighAngle); ctx.beginPath(); ctx.roundRect(-5, 0, 10, 14, 5); ctx.fill(); ctx.translate(0, 12); ctx.rotate(rCalfAngle); ctx.beginPath(); ctx.roundRect(-4, 0, 8, 14, 4); ctx.fill(); ctx.translate(0, 14); ctx.rotate(-rCalfAngle - rThighAngle + 0.2); ctx.fillStyle = '#000'; ctx.beginPath(); ctx.roundRect(-4, 0, 12, 6, 2); ctx.fill(); ctx.restore();
            ctx.fillStyle = '#111'; ctx.beginPath(); ctx.roundRect(10, 35, 30, 25, 4); ctx.fill(); ctx.fillStyle = '#333'; ctx.fillRect(22, 35, 6, 25);
            ctx.save(); ctx.translate(25, 47); ctx.rotate(-tilt); ctx.scale(0.12, 0.12); ctx.fillStyle = '#76b900'; ctx.beginPath(); ctx.moveTo(-38.9, -11.9); ctx.bezierCurveTo(-29.1, -25.4, -12.1, -34.2, 7.1, -34.2); ctx.bezierCurveTo(26.3, -34.2, 43.3, -25.4, 53.1, -11.9); ctx.bezierCurveTo(48.6, -1.9, 38.5, 6.5, 25.9, 11.8); ctx.bezierCurveTo(16.6, 15.6, 6.3, 18, -4.5, 18.9); ctx.bezierCurveTo(-20.1, 20.1, -35.3, 16.7, -46.7, 9.5); ctx.bezierCurveTo(-45.3, 1.6, -42.7, -5.5, -38.9, -11.9); ctx.fill(); ctx.fillStyle = '#333'; ctx.beginPath(); ctx.moveTo(7.4, -10.9); ctx.bezierCurveTo(17.4, -17.4, 27.9, -9.4, 23.9, 2.9); ctx.bezierCurveTo(19.9, 15.1, 5.3, 11.9, -2.3, 2.9); ctx.bezierCurveTo(-8.3, -4.6, -1.1, -15.8, 7.4, -10.9); ctx.fill(); ctx.fillStyle = '#76b900'; ctx.beginPath(); ctx.arc(7.5, -2.5, 6.5, 0, Math.PI*2); ctx.fill(); ctx.restore();
            ctx.strokeStyle = '#555'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(10, 35); ctx.lineTo(20, 45); ctx.stroke(); ctx.beginPath(); ctx.moveTo(40, 35); ctx.lineTo(30, 45); ctx.stroke();
            ctx.fillStyle = '#2a2a2a'; ctx.save(); ctx.translate(22, 55); ctx.rotate(lThighAngle); ctx.beginPath(); ctx.roundRect(-5, 0, 10, 14, 5); ctx.fill(); ctx.translate(0, 12); ctx.rotate(lCalfAngle); ctx.beginPath(); ctx.roundRect(-4, 0, 8, 14, 4); ctx.fill(); ctx.translate(0, 14); ctx.rotate(-lCalfAngle - lThighAngle + 0.2); ctx.fillStyle = '#000'; ctx.beginPath(); ctx.roundRect(-4, 0, 12, 6, 2); ctx.fill(); ctx.restore();
            let rArmAngle = this.grounded ? Math.sin(cycle) * 0.4 : -0.2; let lArmAngle = this.grounded ? Math.sin(cycle + Math.PI) * 0.4 : 0.2; ctx.fillStyle = '#111'; ctx.save(); ctx.translate(15, 38); ctx.rotate(rArmAngle); ctx.beginPath(); ctx.roundRect(-4, 0, 8, 18, 4); ctx.fill(); ctx.translate(0, 16); ctx.rotate(-0.5); ctx.beginPath(); ctx.roundRect(-3, 0, 6, 16, 3); ctx.fill(); ctx.fillStyle = '#f5d0b0'; ctx.beginPath(); ctx.arc(0, 18, 4, 0, Math.PI*2); ctx.fill(); ctx.restore();
            ctx.fillStyle = '#111'; ctx.save(); ctx.translate(35, 38); if (this.shootTimer > 5) { ctx.rotate(-1.2); ctx.beginPath(); ctx.roundRect(-4, 0, 8, 25, 4); ctx.fill(); } else { ctx.rotate(lArmAngle); ctx.beginPath(); ctx.roundRect(-4, 0, 8, 18, 4); ctx.fill(); ctx.translate(0, 16); ctx.rotate(-0.8); ctx.beginPath(); ctx.roundRect(-3, 0, 6, 16, 3); ctx.fill(); } ctx.fillStyle = '#f5d0b0'; ctx.beginPath(); ctx.arc(0, 18, 4, 0, Math.PI*2); ctx.fill(); ctx.restore();
            ctx.save(); ctx.rotate(-tilt); ctx.fillStyle = '#f5d0b0'; ctx.beginPath(); ctx.ellipse(25, 20, 18, 16, 0, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(8, 22, 4, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(42, 22, 4, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = '#c98c61'; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.arc(25, 26, 6, 0.2, Math.PI - 0.2); ctx.stroke();
            ctx.strokeStyle = '#000'; ctx.lineWidth = 2.5; ctx.fillStyle = '#000'; ctx.beginPath(); ctx.roundRect(5, 15, 8, 4, 2); ctx.roundRect(37, 15, 8, 4, 2); ctx.fill(); ctx.beginPath(); ctx.roundRect(11, 14, 13, 11, 3); ctx.stroke(); ctx.beginPath(); ctx.roundRect(26, 14, 13, 11, 3); ctx.stroke(); ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(24, 17); ctx.lineTo(26, 17); ctx.stroke(); ctx.fillStyle = 'rgba(200, 220, 255, 0.4)'; ctx.beginPath(); ctx.roundRect(11, 14, 13, 11, 3); ctx.fill(); ctx.beginPath(); ctx.roundRect(26, 14, 13, 11, 3); ctx.fill(); ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(17.5, 19.5, 2.5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(32.5, 19.5, 2.5, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#e0e0e0'; ctx.beginPath(); ctx.moveTo(8, 20); ctx.lineTo(6, 10); ctx.bezierCurveTo(10, -5, 40, -5, 44, 10); ctx.lineTo(42, 20); ctx.bezierCurveTo(35, 10, 15, 10, 8, 20); ctx.fill(); ctx.strokeStyle = '#bbb'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(15, 5); ctx.quadraticCurveTo(25, 0, 35, 5); ctx.stroke(); ctx.restore(); ctx.restore(); 
        }
    }

    function start() {
        initAudio();
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-over-screen').style.display = 'none';
        score = 100.00; marketCap = 1.0; 
        contractsCollected = 0;
        updateContractUI(0);
        frames = 0; gameSpeed = 5; isParabolic = false;
        player = new Player(); bullets = []; bears = []; particles = []; powerups = []; contracts = [];
        initTerrain(); gameRunning = true; requestAnimationFrame(loop);
    }

    function gameOver() {
        gameRunning = false;
        document.getElementById('final-score').innerText = score.toFixed(2);
        document.getElementById('final-market-cap').innerText = marketCap.toFixed(2);
        document.getElementById('game-over-screen').style.display = 'flex';
    }

    function loop() {
        if (!gameRunning) return;
        let speedMult = isParabolic ? 2.0 : 1.0;
        gameSpeed = 5 * speedMult;
        frames++;
        if (isParabolic) { parabolicTimer--; updateContractUI(Math.ceil((parabolicTimer / 600) * 15)); if (parabolicTimer <= 0) endParabolicMode(); score += 0.5; } else { score += 0.1; }
        marketCap = score / 100;
        ctx.clearRect(0, 0, width, height);
        updateTerrain(); drawTerrain();
        player.update(); player.draw();
        if (frames % 120 === 0 && Math.random() < 0.8) bears.push(new Bear());
        if (frames % 400 === 0 && Math.random() < 0.5) powerups.push(new PowerUp());
        if (frames % 150 === 0 && Math.random() < 0.7) contracts.push(new Contract());
        bullets.forEach(b => { b.update(); b.draw(); }); bullets = bullets.filter(b => b.active);
        powerups.forEach(p => { p.update(); p.draw(); if (p.active && player.x < p.x + p.width && player.x + player.width > p.x && player.y < p.y + p.height && player.y + player.height > p.y) { p.active = false; player.activatePowerUp(); score += 50; } }); powerups = powerups.filter(p => p.active);
        contracts.forEach(c => { c.update(); c.draw(); if (c.active && player.x < c.x + c.width && player.x + player.width > c.x && player.y < c.y + c.height && player.y + player.height > c.y) { c.active = false; score += 50; collectContract(); } }); contracts = contracts.filter(c => c.active);
        bears.forEach(bear => { bear.update(); bear.draw(); bullets.forEach(bullet => { if (bullet.active && bear.active && bullet.x < bear.x + bear.width && bullet.x + bullet.width > bear.x && bullet.y < bear.y + bear.height && bullet.y + bullet.height > bear.y) { bullet.active = false; bear.active = false; score += 5.0; playSound('hit'); for(let i=0; i<10; i++) particles.push(new Particle(bear.x + bear.width/2, bear.y + bear.height/2)); } }); let px = player.x + 10; let py = player.y + 10; let pw = player.width - 20; let ph = player.height - 20; if (bear.active && px < bear.x + bear.width - 10 && px + pw > bear.x + 10 && py < bear.y + bear.height && py + ph > bear.y) { if (isParabolic) { bear.active = false; playSound('hit'); } else if (player.isOverclocked) { player.losePowerUp(); bear.active = false; } else { gameOver(); } } }); bears = bears.filter(b => b.active);
        particles.forEach(p => { p.update(); p.draw(); }); particles = particles.filter(p => p.life > 0);
        document.getElementById('score').innerText = score.toFixed(2);
        document.getElementById('market-cap').innerText = marketCap.toFixed(2);
        requestAnimationFrame(loop);
    }

    function handleAction(isJump) { if (!gameRunning) return; initAudio(); if (isJump) player.jump(); else player.shoot(); }
    window.addEventListener('keydown', e => { if (e.code === 'Space') handleAction(true); if (e.code === 'KeyF') handleAction(false); });
    canvas.addEventListener('touchstart', e => { e.preventDefault(); const touchX = e.touches[0].clientX; handleAction(touchX < width / 2); }, { passive: false });
    document.getElementById('start-btn').addEventListener('click', start);
    document.getElementById('restart-btn').addEventListener('click', start);
</script>
</body>
</html>
